upstream admin-app {
  ip_hash;
  server ghost:2368 weight=10 max_fails=3 fail_timeout=30s;
}

upstream web-app {
  ip_hash;
  server web:3000 weight=10 max_fails=3 fail_timeout=30s;
}

upstream viz-app {
  ip_hash;
  server viz:8080 weight=10 max_fails=3 fail_timeout=30s;
}

# WEB - FRONTEND Next.js - React.js DEV
server {
  listen 80;
  listen [::]:80;

  root /var/www/html;
  index index.html index.htm index.nginx-debian.html;

  server_name johnserrano.xyz www.johnserrano.xyz;

  access_log /var/log/nginx/johnserrano.xyz.access.log;
  error_log /var/log/nginx/johnserrano.xyz.error.log;

  location / {
    # proxy_cache            STATIC;
    # proxy_cache_valid      200  1d;
    proxy_cache_use_stale  error timeout invalid_header updating
                                   http_500 http_502 http_503 http_504;
    proxy_cache_bypass $http_cache_control;
    add_header X-Proxy-Cache $upstream_cache_status;

    proxy_read_timeout    90;
    proxy_connect_timeout 90;
    proxy_redirect        off;
    proxy_set_header      X-Real-IP $remote_addr;
    proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header      Host $host;
    proxy_pass http://web-app;
  }

  location ~ /.well-known/acme-challenge {
    allow all;
    root /var/www/html;
  }

}

# Redirect blog.domain to domain/blog
server {
  listen 80;
  listen [::]:80;

  server_name blog.johnserrano.xyz;

  location /blog {
    # Empty; this is just here to avoid redirecting for this location,
    # though you might already have some config in a block like this.
  }
  
  location / {
    # rewrite ^/(.*)$ $scheme://johnserrano.xyz/blog/$1 redirect;
    rewrite ^/(.*)$ $scheme://johnserrano.xyz/blog$request_uri redirect;
  }

  rewrite ^/(.*)/$ /$1 permanent;

  # return 301 $scheme://johnserrano.xyz$request_uri;
}

# visualizer
server {
  listen 80;
  listen [::]:80;

  root /var/www/html;
  index index.html index.htm index.nginx-debian.html;

  server_name viz.johnserrano.xyz;

  access_log /var/log/nginx/viz.johnserrano.xyz.access.log;
  error_log /var/log/nginx/viz.johnserrano.xyz.error.log;

  location / {

    proxy_read_timeout    90;
    proxy_connect_timeout 90;
    proxy_redirect        off;
    proxy_set_header      X-Real-IP $remote_addr;
    proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header      Host $host;
    proxy_pass http://viz-app;
  }
}
